<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>テスト実行</title>
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/minecraft-font.css">
<style>
.test-wrap{max-width:900px;margin:30px auto;padding:20px;background:rgba(0,0,0,.6);border:3px solid #fff;border-radius:12px;color:#fff}
.story-box{background:rgba(255,255,255,.1);padding:15px;border-radius:8px;font-size:14px;line-height:1.6;margin:15px 0}
#nextBtn{display:none;margin-top:20px;width:240px;}
#autoMsg{font-size:12px;color:#ccc;margin-top:8px;display:none}
</style>
</head>
<body class="test-bg">
<div class="test-wrap">
  <a href="test.html" class="back-link" style="display:inline-block;margin-bottom:8px;font-size:12px;color:#fff;text-decoration:underline;">← テスト一覧（現在の1件）</a>
  <h1 class="mc-title" style="font-size:26px;margin-bottom:10px;">テスト</h1>
  <img id="headerImg" src="" alt="テスト画像" style="width:100%;max-width:600px;border:3px solid #fff;display:none">
  <div id="story" class="story-box" style="display:none"></div>
  <div id="questions"></div>
  <button id="checkBtn" class="btn" style="width:220px;display:none">答え合わせ</button>
  <p id="result" style="margin-top:15px;font-size:18px"></p>
  <button id="nextBtn" class="btn">▶ つぎのテストへ</button>
  <div id="autoMsg">5秒後に つぎのテスト チェック画面へ もどります…</div>
  <div id="errorBox" style="color:#ffaaaa;margin-top:20px;"></div>
</div>

<script type="module">
import { addScore, archiveTest, isArchived, firstPendingId, playClick } from './js/app.js';

const params = new URLSearchParams(location.search);
const testId = params.get('id') || '1';

const storyElm  = document.getElementById('story');
const imgElm    = document.getElementById('headerImg');
const qWrap     = document.getElementById('questions');
const checkBtn  = document.getElementById('checkBtn');
const resultElm = document.getElementById('result');
const errBox    = document.getElementById('errorBox');
const nextBtn   = document.getElementById('nextBtn');
const autoMsg   = document.getElementById('autoMsg');

function showError(msg){ errBox.textContent = msg; }

let currentTest = null;

(async ()=>{
  let data;
  try{
    const res = await fetch('./tests.json',{cache:'no-store'});
    if(!res.ok){ showError('tests.json 読み込み失敗: HTTP '+res.status); return; }
    data = await res.json();
  }catch(e){
    showError('ネットワーク / JSON エラー: '+e.message);
    return;
  }
  if(!data.tests || !Array.isArray(data.tests)){ showError('tests 配列なし'); return; }

  currentTest = data.tests.find(t=> String(t.id) === String(testId));
  if(!currentTest){ showError('テストが見つかりません: id='+testId); return; }

  if(currentTest.image){
    imgElm.src = 'media/' + currentTest.image;
    imgElm.style.display='block';
  }
  storyElm.textContent = currentTest.story || '';
  storyElm.style.display='block';

  (currentTest.questions || []).forEach((qObj, idx)=>{
    const wrap = document.createElement('div');
    wrap.className='question';
    wrap.innerHTML = `<p>${idx+1}. ${escapeHTML(qObj.q||'')}</p>`;
    const ansDiv = document.createElement('div'); ansDiv.className='answers';
    (qObj.choices || []).forEach((ch,i)=>{
      const label = document.createElement('label');
      const correct = (i === qObj.correct);
      label.innerHTML = `<input type="radio" name="q${idx}" value="${correct?1:0}"> ${escapeHTML(ch)}`;
      ansDiv.appendChild(label);
    });
    const exp = document.createElement('div');
    exp.className='explanation';
    exp.textContent = qObj.explain || '';
    wrap.appendChild(ansDiv);
    wrap.appendChild(exp);
    qWrap.appendChild(wrap);
  });

  checkBtn.style.display='inline-block';
  if(isArchived(testId)){
    // 既に完了済みなら採点無効化＆次ボタン表示
    finalizeUI(data);
    return;
  }

  checkBtn.addEventListener('click', ()=>{
    playClick();
    let score=0;
    document.querySelectorAll('.question').forEach(qEl=>{
      const sel = qEl.querySelector('input[type=radio]:checked');
      const labels = qEl.querySelectorAll('label');
      const exp = qEl.querySelector('.explanation');
      labels.forEach(l=>l.classList.remove('correct','wrong'));
      if(sel){
        if(sel.value==='1'){
          score++;
          sel.parentElement.classList.add('correct');
        }else{
          sel.parentElement.classList.add('wrong');
          labels.forEach(l=>{
            if(l.querySelector('input').value==='1') l.classList.add('correct');
          });
        }
      }
      exp.style.display='block';
    });
    resultElm.textContent = `正解数：${score} / ${currentTest.questions.length}`;
    checkBtn.disabled = true;

    // 保存 & アーカイブ
    addScore({id:String(testId),score,date:new Date().toLocaleString()});
    archiveTest(String(testId));

    // 次テスト誘導
    finalizeUI(data);
  });

  nextBtn.addEventListener('click',()=>{
    playClick();
    window.location.href='test.html'; // test.html が次の未完了を出す
  });

})();

function finalizeUI(allData){
  // 次の未完了を判定（現在のを除いた後）
  const remaining = (allData.tests || []).filter(t=> String(t.id)!==String(testId));
  const nextId = firstPendingId(remaining);
  if(nextId){
    nextBtn.style.display='inline-block';
    autoMsg.style.display='block';
    // 5秒後自動遷移（変更可）
    setTimeout(()=>{ window.location.href='test.html'; }, 5000);
  }else{
    resultElm.textContent += ' （すべてのテストをクリアしました！）';
  }
}

function escapeHTML(str){
  return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
}
</script>
</body>
</html>
